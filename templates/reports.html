{% extends "base.html" %}

{% block title %}Reports - Traccar Dashboard{% endblock %}

{% block extra_css %}
<style>
    .report-container {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stats-card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .device-selector {
        max-height: 300px;
        overflow-y: auto;
    }

    .export-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 1.5rem;
    }

    .pdf-preview {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        background: white;
        margin: 1rem 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .company-header {
        border-bottom: 3px solid #0d6efd;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
    }

    .report-table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .loading-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    @media print {
        .no-print {
            display: none !important;
        }

        .pdf-preview {
            box-shadow: none;
            border: none;
            margin: 0;
            padding: 0;
        }

        .company-header {
            border-bottom: 2px solid #000;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h5>Generazione PDF in corso...</h5>
        <p class="text-muted mb-0">Elaborazione dati e creazione documento</p>
    </div>
</div>

<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="page-title mb-1">
                <i class="fas fa-chart-line text-primary"></i> Reports e Analisi
            </h2>
            <p class="text-muted mb-0">Genera report dettagliati sui movimenti e le statistiche dei dispositivi</p>
        </div>
        <div class="connection-status">
            <span class="badge bg-success">
                <i class="fas fa-database"></i> Sistema Attivo
            </span>
        </div>
    </div>
</div>

<div class="row">
    <!-- Sidebar Parameters -->
    <div class="col-md-3">
        <div class="card report-container no-print">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-filter"></i> Parametri Report
                </h5>
            </div>
            <div class="card-body">
                <!-- Device Selection -->
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-mobile-alt text-primary"></i> Dispositivi
                    </label>
                    <div class="mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllDevices">
                            <label class="form-check-label fw-bold" for="selectAllDevices">
                                Seleziona Tutti
                            </label>
                        </div>
                    </div>
                    <select class="form-select device-selector" id="deviceSelect" multiple size="6">
                        <!-- Devices loaded via JavaScript -->
                    </select>
                    <div class="form-text">
                        <i class="fas fa-info-circle"></i> Tieni premuto Ctrl per selezioni multiple
                    </div>
                </div>

                <!-- Date Range -->
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-calendar text-primary"></i> Periodo
                    </label>
                    <select class="form-select mb-2" id="datePreset">
                        <option value="today">Oggi</option>
                        <option value="yesterday">Ieri</option>
                        <option value="week">Ultima Settimana</option>
                        <option value="month">Ultimo Mese</option>
                        <option value="custom">Personalizzato</option>
                    </select>

                    <div id="customDateRange" style="display: none;">
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small">Da</label>
                                <input type="date" class="form-control form-control-sm" id="fromDate">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">A</label>
                                <input type="date" class="form-control form-control-sm" id="toDate">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Type -->
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-chart-bar text-primary"></i> Tipo Report
                    </label>
                    <select class="form-select" id="reportType">
                        <option value="summary">Riepilogo Generale</option>
                        <option value="routes">Analisi Percorsi</option>
                        <option value="stops">Analisi Soste</option>
                        <option value="trips">Dettaglio Viaggi</option>
                        <option value="performance">Performance Veicoli</option>
                    </select>
                </div>

                <!-- Generate Button -->
                <button class="btn btn-primary w-100 mb-3" onclick="generateReport()">
                    <i class="fas fa-play"></i> Genera Report
                </button>

                <!-- Export Section -->
                <div class="export-section">
                    <h6 class="mb-3">
                        <i class="fas fa-download"></i> Esportazione
                    </h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-light btn-sm" onclick="exportReport('pdf')" disabled id="exportPDF">
                            <i class="fas fa-file-pdf text-danger"></i> PDF Professionale
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="exportReport('excel')" disabled id="exportExcel">
                            <i class="fas fa-file-excel text-success"></i> Excel
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="exportReport('csv')" disabled id="exportCSV">
                            <i class="fas fa-file-csv text-info"></i> CSV
                        </button>
                    </div>

                    <!-- PDF Options -->
                    <div class="mt-3" id="pdfOptions" style="display: none;">
                        <h6 class="small mb-2">Opzioni PDF:</h6>
                        <div class="form-check form-check-reverse">
                            <input class="form-check-input" type="checkbox" id="includeLogo" checked>
                            <label class="form-check-label small" for="includeLogo">
                                Includi Logo Aziendale
                            </label>
                        </div>
                        <div class="form-check form-check-reverse">
                            <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                            <label class="form-check-label small" for="includeCharts">
                                Grafici e Statistiche
                            </label>
                        </div>
                        <div class="form-check form-check-reverse">
                            <input class="form-check-input" type="checkbox" id="includeMap" checked>
                            <label class="form-check-label small" for="includeMap">
                                Mappa Percorsi
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
        <!-- Statistics Cards -->
        <div class="row mb-4 no-print" id="statsCards" style="display: none;">
            <div class="col-md-3">
                <div class="card stats-card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-route fa-2x mb-2"></i>
                        <h4 id="totalDistance">0 km</h4>
                        <p class="mb-0">Distanza Totale</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h4 id="totalTime">0h 0m</h4>
                        <p class="mb-0">Tempo di Viaggio</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-tachometer-alt fa-2x mb-2"></i>
                        <h4 id="avgSpeed">0 km/h</h4>
                        <p class="mb-0">Velocità Media</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-danger text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h4 id="maxSpeed">0 km/h</h4>
                        <p class="mb-0">Velocità Massima</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Content -->
        <div class="card report-container">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Report Generato
                    </h5>
                    <div id="reportInfo" style="display: none;">
                        <small class="text-muted" id="reportGeneratedAt"></small>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- PDF Preview Container -->
                <div id="pdfPreview" class="pdf-preview" style="display: none;">
                    <!-- Company Header -->
                    <div class="company-header">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img id="companyLogo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiMwZDZlZmQiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0tMiAxNWwtNS01IDEuNDEtMS40MUwxMCAxNC4xN2w3LjU5LTcuNTlMMTkgOGwtOSA5eiIvPgo8L3N2Zz4KPC9zdmc+"
                                     alt="Logo Azienda"
                                     class="img-fluid"
                                     style="max-width: 80px;">
                            </div>
                            <div class="col-md-7">
                                <h2 class="fw-bold text-primary mb-1" id="companyName">Traccar GPS Solutions</h2>
                                <p class="mb-1 text-muted">Sistema di Monitoraggio e Tracking GPS</p>
                                <p class="mb-0 small text-muted">Via Roma 123, 00100 Roma | Tel: +39 06 1234567 | info@traccar.it</p>
                            </div>
                            <div class="col-md-3 text-end">
                                <h4 class="fw-bold text-primary mb-1">REPORT GPS</h4>
                                <p class="mb-0 small text-muted" id="reportDate"></p>
                                <p class="mb-0 small text-muted" id="reportNumber"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Report Content Area -->
                    <div id="reportContentPDF">
                        <!-- Content will be inserted here -->
                    </div>

                    <!-- Footer -->
                    <div class="text-center mt-4 pt-3" style="border-top: 1px solid #dee2e6;">
                        <small class="text-muted">
                            Report generato automaticamente da Traccar GPS Solutions -
                            <span id="generationTimestamp"></span>
                        </small>
                    </div>
                </div>

                <!-- Regular Report Content -->
                <div id="reportContent">
                    <div class="text-center p-5 text-muted">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <h5>Nessun Report Generato</h5>
                        <p>Seleziona i parametri e clicca "Genera Report" per iniziare</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/reports.js') }}"></script>
{% endblock %}