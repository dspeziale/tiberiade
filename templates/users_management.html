{% extends "base.html" %}

{% block title %}Gestione Utenti - Traccar{% endblock %}

{% block page_title %}Gestione Utenti{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('settings') }}">Impostazioni</a></li>
        <li class="breadcrumb-item active">Utenti</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3><i class="fas fa-users"></i> Gestione Utenti</h3>
                    <p class="text-muted mb-0">Gestisci utenti e permessi del sistema</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="fas fa-plus"></i> Nuovo Utente
                    </button>
                    <button class="btn btn-outline-secondary" onclick="loadUsers()">
                        <i class="fas fa-sync-alt"></i> Ricarica
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h4 id="totalUsers">0</h4>
                    <p class="mb-0">Utenti Totali</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-user-check fa-2x mb-2"></i>
                    <h4 id="activeUsers">0</h4>
                    <p class="mb-0">Attivi</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-user-shield fa-2x mb-2"></i>
                    <h4 id="adminUsers">0</h4>
                    <p class="mb-0">Amministratori</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h4 id="onlineUsers">0</h4>
                    <p class="mb-0">Online Ora</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput"
                                       placeholder="Cerca per nome o email...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" id="roleFilter">
                                <option value="">Tutti i ruoli</option>
                                <option value="admin">Amministratore</option>
                                <option value="manager">Manager</option>
                                <option value="user">Utente</option>
                                <option value="readonly">Solo Lettura</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" id="statusFilter">
                                <option value="">Tutti gli stati</option>
                                <option value="active">Attivi</option>
                                <option value="disabled">Disabilitati</option>
                                <option value="expired">Scaduti</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" id="sortBy">
                                <option value="name">Nome</option>
                                <option value="email">Email</option>
                                <option value="created">Data Creazione</option>
                                <option value="lastLogin">Ultimo Accesso</option>
                            </select>
                        </div>
                        <div class="col-md-2 text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="selectAllUsers()">
                                    <i class="fas fa-check-square"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="bulkDeleteUsers()" disabled id="bulkDeleteBtn">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-table"></i> Lista Utenti</h5>
            <div>
                <button class="btn btn-sm btn-outline-success" onclick="exportUsers()">
                    <i class="fas fa-download"></i> Esporta
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="importUsers()">
                    <i class="fas fa-upload"></i> Importa
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="loadingSpinner" class="text-center p-5" style="display: none;">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                <div class="mt-3">
                    <h5>Caricamento utenti...</h5>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover mb-0" id="usersTable">
                    <thead class="table-dark">
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th>Utente</th>
                            <th>Email</th>
                            <th>Ruolo</th>
                            <th>Dispositivi</th>
                            <th>Stato</th>
                            <th>Ultimo Accesso</th>
                            <th>Creato</th>
                            <th width="150">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Gli utenti verranno caricati qui -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyMessage" class="text-center p-5" style="display: none;">
        <div class="mb-4">
            <i class="fas fa-users fa-4x text-muted"></i>
        </div>
        <h4 class="text-muted">Nessun utente trovato</h4>
        <p class="text-muted">Inizia aggiungendo il primo utente al sistema</p>
        <button class="btn btn-primary" onclick="showAddUserModal()">
            <i class="fas fa-plus"></i> Aggiungi Primo Utente
        </button>
    </div>
</div>

<!-- Modal Add/Edit User -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">
                    <i class="fas fa-plus"></i> Nuovo Utente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId" name="id">

                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-user"></i> Informazioni Base
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="userName" name="name" required
                                   placeholder="Es: Mario Rossi">
                            <div class="form-text">Nome e cognome dell'utente</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="userEmail" name="email" required
                                   placeholder="mario.rossi@example.com">
                            <div class="form-text">Indirizzo email per l'accesso</div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-key"></i> Credenziali
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Password *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="userPassword" name="password"
                                       placeholder="Password sicura">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('userPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">Minimo 8 caratteri con maiuscole, minuscole e numeri</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Conferma Password *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="userPasswordConfirm" name="passwordConfirm"
                                       placeholder="Ripeti password">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('userPasswordConfirm')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-shield-alt"></i> Ruolo e Permessi
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ruolo Utente</label>
                            <select class="form-select" id="userRole" name="role">
                                <option value="user" selected>Utente Standard</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Amministratore</option>
                                <option value="readonly">Solo Lettura</option>
                            </select>
                            <div class="form-text">Determina i permessi dell'utente</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data Scadenza</label>
                            <input type="date" class="form-control" id="userExpirationDate" name="expirationDate">
                            <div class="form-text">Lascia vuoto per nessuna scadenza</div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-mobile-alt"></i> Dispositivi Assegnati
                            </h6>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="allDevicesAccess" name="allDevicesAccess">
                                <label class="form-check-label" for="allDevicesAccess">
                                    <strong>Accesso a tutti i dispositivi</strong>
                                </label>
                                <div class="form-text">Se abilitato, l'utente può vedere tutti i dispositivi</div>
                            </div>

                            <div id="deviceSelectionContainer">
                                <label class="form-label">Dispositivi Specifici</label>
                                <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    <div id="devicesList">
                                        <!-- I dispositivi verranno caricati qui -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-cogs"></i> Opzioni Avanzate
                            </h6>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="userDisabled" name="disabled">
                                <label class="form-check-label" for="userDisabled">
                                    Account Disabilitato
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="userReadonly" name="readonly">
                                <label class="form-check-label" for="userReadonly">
                                    Solo Lettura
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="userLimitCommands" name="limitCommands" checked>
                                <label class="form-check-label" for="userLimitCommands">
                                    Limita Comandi
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle"></i> Informazioni Aggiuntive
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefono</label>
                            <input type="tel" class="form-control" id="userPhone" name="phone"
                                   placeholder="+39 123 456 7890">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Coordinate Mappa</label>
                            <input type="text" class="form-control" id="userCoordinates" name="coordinates"
                                   placeholder="41.9028, 12.4964">
                            <div class="form-text">Posizione predefinita sulla mappa</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Note</label>
                            <textarea class="form-control" id="userNotes" name="notes" rows="3"
                                      placeholder="Note aggiuntive sull'utente..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">
                    <i class="fas fa-save"></i> <span id="saveUserButtonText">Salva Utente</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Delete Confirmation -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Conferma Eliminazione
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Attenzione!</strong> Questa azione eliminerà permanentemente l'utente e tutte le sue configurazioni.
                </div>
                <p>Sei sicuro di voler eliminare l'utente: <strong id="userToDeleteName"></strong>?</p>
                <div class="bg-light p-3 rounded" id="userToDeleteInfo">
                    <!-- Informazioni utente da eliminare -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Annulla
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()">
                    <i class="fas fa-trash"></i> Elimina Utente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal User Details -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-circle"></i> Dettagli Utente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="userDetailsContent">
                    <!-- Contenuto dettagli utente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Chiudi
                </button>
                <button type="button" class="btn btn-primary" onclick="editUserFromDetails()">
                    <i class="fas fa-edit"></i> Modifica
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allUsers = [];
let allDevices = [];
let selectedUsers = [];
let isEditingUser = false;
let userToDeleteId = null;
let currentUserDetails = null;

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadDevices();
    setupEventListeners();
});

function setupEventListeners() {
    // Search and filters
    document.getElementById('searchInput').addEventListener('input', filterUsers);
    document.getElementById('roleFilter').addEventListener('change', filterUsers);
    document.getElementById('statusFilter').addEventListener('change', filterUsers);
    document.getElementById('sortBy').addEventListener('change', sortUsers);

    // Device access toggle
    document.getElementById('allDevicesAccess').addEventListener('change', function() {
        const container = document.getElementById('deviceSelectionContainer');
        container.style.display = this.checked ? 'none' : 'block';
    });

    // Form validation
    document.getElementById('userPassword').addEventListener('input', validatePassword);
    document.getElementById('userPasswordConfirm').addEventListener('input', validatePasswordMatch);
}

function loadUsers() {
    showLoading(true);

    fetch('/api/users')
        .then(response => response.json())
        .then(users => {
            allUsers = users;
            updateUserStatistics();
            renderUsersTable();
            showLoading(false);
        })
        .catch(error => {
            console.error('Errore nel caricamento utenti:', error);
            showAlert('Errore nel caricamento degli utenti', 'danger');
            showEmptyMessage();
            showLoading(false);
        });
}

function loadDevices() {
    fetch('/api/devices')
        .then(response => response.json())
        .then(devices => {
            allDevices = devices;
            renderDevicesList();
        })
        .catch(error => {
            console.error('Errore nel caricamento dispositivi:', error);
        });
}

function updateUserStatistics() {
    const total = allUsers.length;
    const active = allUsers.filter(user => !user.disabled && !isExpired(user)).length;
    const admin = allUsers.filter(user => user.role === 'admin').length;
    const online = allUsers.filter(user => isUserOnline(user)).length;

    document.getElementById('totalUsers').textContent = total;
    document.getElementById('activeUsers').textContent = active;
    document.getElementById('adminUsers').textContent = admin;
    document.getElementById('onlineUsers').textContent = online;
}

function renderUsersTable() {
    const tbody = document.getElementById('usersTableBody');

    if (allUsers.length === 0) {
        showEmptyMessage();
        return;
    }

    tbody.innerHTML = '';

    allUsers.forEach(user => {
        const isActive = !user.disabled && !isExpired(user);
        const lastLogin = user.lastLogin ? formatDateTime(user.lastLogin) : 'Mai';
        const created = user.created ? formatDateTime(user.created) : 'N/A';
        const deviceCount = user.deviceIds ? user.deviceIds.length : 0;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" class="user-checkbox" value="${user.id}"
                       onchange="updateBulkActions()">
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="user-avatar me-2">
                        <i class="fas fa-user-circle fa-2x ${getRoleColor(user.role)}"></i>
                    </div>
                    <div>
                        <strong>${user.name}</strong>
                        ${user.disabled ? '<span class="badge bg-secondary ms-1">Disabilitato</span>' : ''}
                        ${isExpired(user) ? '<span class="badge bg-warning ms-1">Scaduto</span>' : ''}
                        ${isUserOnline(user) ? '<span class="badge bg-success ms-1"><i class="fas fa-circle"></i> Online</span>' : ''}
                    </div>
                </div>
            </td>
            <td>
                <a href="mailto:${user.email}" class="text-decoration-none">${user.email}</a>
            </td>
            <td>
                <span class="badge ${getRoleBadgeClass(user.role)}">
                    <i class="fas ${getRoleIcon(user.role)}"></i> ${getRoleName(user.role)}
                </span>
            </td>
            <td>
                <span class="badge ${deviceCount > 0 ? 'bg-info' : 'bg-secondary'}">
                    ${user.allDevicesAccess ? 'Tutti' : deviceCount}
                </span>
            </td>
            <td>
                <span class="badge ${isActive ? 'bg-success' : 'bg-danger'}">
                    ${isActive ? 'Attivo' : 'Inattivo'}
                </span>
            </td>
            <td>
                <small>${lastLogin}</small>
            </td>
            <td>
                <small>${created}</small>
            </td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-info btn-sm" onclick="viewUser(${user.id})"
                            title="Visualizza">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="editUser(${user.id})"
                            title="Modifica">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="showDeleteUserModal(${user.id})"
                            title="Elimina">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    document.getElementById('usersTable').parentElement.parentElement.style.display = 'block';
    document.getElementById('emptyMessage').style.display = 'none';
}

function renderDevicesList() {
    const container = document.getElementById('devicesList');
    container.innerHTML = '';

    if (allDevices.length === 0) {
        container.innerHTML = '<p class="text-muted">Nessun dispositivo disponibile</p>';
        return;
    }

    allDevices.forEach(device => {
        const deviceItem = document.createElement('div');
        deviceItem.className = 'form-check mb-2';
        deviceItem.innerHTML = `
            <input class="form-check-input device-check" type="checkbox"
                   value="${device.id}" id="device_${device.id}">
            <label class="form-check-label" for="device_${device.id}">
                <strong>${device.name}</strong>
                <br><small class="text-muted">IMEI: ${device.uniqueId}</small>
            </label>
        `;
        container.appendChild(deviceItem);
    });
}

function showAddUserModal() {
    resetUserForm();
    isEditingUser = false;
    document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-plus"></i> Nuovo Utente';
    document.getElementById('saveUserButtonText').textContent = 'Salva Utente';

    // Make password fields required for new users
    document.getElementById('userPassword').required = true;
    document.getElementById('userPasswordConfirm').required = true;

    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

function editUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;

    isEditingUser = true;
    document.getElementById('userModalTitle').innerHTML = '<i class="fas fa-edit"></i> Modifica Utente';
    document.getElementById('saveUserButtonText').textContent = 'Aggiorna Utente';

    // Populate form
    document.getElementById('userId').value = user.id;
    document.getElementById('userName').value = user.name || '';
    document.getElementById('userEmail').value = user.email || '';
    document.getElementById('userRole').value = user.role || 'user';
    document.getElementById('userExpirationDate').value = user.expirationDate || '';
    document.getElementById('userPhone').value = user.phone || '';
    document.getElementById('userCoordinates').value = user.coordinates || '';
    document.getElementById('userNotes').value = user.notes || '';
    document.getElementById('userDisabled').checked = user.disabled || false;
    document.getElementById('userReadonly').checked = user.readonly || false;
    document.getElementById('userLimitCommands').checked = user.limitCommands !== false;
    document.getElementById('allDevicesAccess').checked = user.allDevicesAccess || false;

    // Handle device selection
    if (user.allDevicesAccess) {
        document.getElementById('deviceSelectionContainer').style.display = 'none';
    } else {
        document.getElementById('deviceSelectionContainer').style.display = 'block';
        // Select user's devices
        document.querySelectorAll('.device-check').forEach(checkbox => {
            checkbox.checked = user.deviceIds && user.deviceIds.includes(parseInt(checkbox.value));
        });
    }

    // Make password fields optional for editing
    document.getElementById('userPassword').required = false;
    document.getElementById('userPasswordConfirm').required = false;
    document.getElementById('userPassword').placeholder = 'Lascia vuoto per mantenere la password attuale';
    document.getElementById('userPasswordConfirm').placeholder = 'Lascia vuoto per mantenere la password attuale';

    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

function viewUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;

    currentUserDetails = user;
    const deviceNames = getUserDeviceNames(user);
    const lastLogin = user.lastLogin ? formatDateTime(user.lastLogin) : 'Mai';
    const created = user.created ? formatDateTime(user.created) : 'N/A';

    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-user"></i> Informazioni Base</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Nome:</strong></td>
                        <td>${user.name}</td>
                    </tr>
                    <tr>
                        <td><strong>Email:</strong></td>
                        <td><a href="mailto:${user.email}">${user.email}</a></td>
                    </tr>
                    <tr>
                        <td><strong>Telefono:</strong></td>
                        <td>${user.phone || 'Non specificato'}</td>
                    </tr>
                    <tr>
                        <td><strong>Ruolo:</strong></td>
                        <td><span class="badge ${getRoleBadgeClass(user.role)}">${getRoleName(user.role)}</span></td>
                    </tr>
                    <tr>
                        <td><strong>Stato:</strong></td>
                        <td>
                            ${!user.disabled && !isExpired(user) ?
                                '<span class="badge bg-success">Attivo</span>' :
                                '<span class="badge bg-danger">Inattivo</span>'}
                            ${user.disabled ? '<span class="badge bg-secondary ms-1">Disabilitato</span>' : ''}
                            ${isExpired(user) ? '<span class="badge bg-warning ms-1">Scaduto</span>' : ''}
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-cogs"></i> Configurazioni</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Accesso Dispositivi:</strong></td>
                        <td>${user.allDevicesAccess ? 'Tutti i dispositivi' : 'Dispositivi specifici'}</td>
                    </tr>
                    <tr>
                        <td><strong>Solo Lettura:</strong></td>
                        <td>${user.readonly ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                    </tr>
                    <tr>
                        <td><strong>Limita Comandi:</strong></td>
                        <td>${user.limitCommands !== false ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                    </tr>
                    <tr>
                        <td><strong>Data Scadenza:</strong></td>
                        <td>${user.expirationDate ? formatDate(user.expirationDate) : 'Nessuna scadenza'}</td>
                    </tr>
                    <tr>
                        <td><strong>Coordinate:</strong></td>
                        <td>${user.coordinates || 'Non specificate'}</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <h6><i class="fas fa-mobile-alt"></i> Dispositivi Assegnati</h6>
                ${user.allDevicesAccess ?
                    '<div class="alert alert-info"><i class="fas fa-info-circle"></i> Questo utente ha accesso a tutti i dispositivi del sistema.</div>' :
                    deviceNames.length > 0 ?
                        '<div class="d-flex flex-wrap gap-2">' + deviceNames.map(name => `<span class="badge bg-primary">${name}</span>`).join('') + '</div>' :
                        '<div class="text-muted">Nessun dispositivo assegnato</div>'
                }
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12">
                <h6><i class="fas fa-clock"></i> Cronologia</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Creato il:</strong></td>
                        <td>${created}</td>
                    </tr>
                    <tr>
                        <td><strong>Ultimo accesso:</strong></td>
                        <td>${lastLogin}</td>
                    </tr>
                    <tr>
                        <td><strong>Stato Online:</strong></td>
                        <td>${isUserOnline(user) ?
                            '<span class="badge bg-success"><i class="fas fa-circle"></i> Online</span>' :
                            '<span class="badge bg-secondary"><i class="fas fa-circle"></i> Offline</span>'}</td>
                    </tr>
                </table>
            </div>
        </div>

        ${user.notes ? `
        <div class="row mt-3">
            <div class="col-12">
                <h6><i class="fas fa-sticky-note"></i> Note</h6>
                <div class="bg-light p-3 rounded">
                    ${user.notes}
                </div>
            </div>
        </div>
        ` : ''}
    `;

    document.getElementById('userDetailsContent').innerHTML = content;
    const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
    modal.show();
}

function showDeleteUserModal(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;

    userToDeleteId = userId;
    document.getElementById('userToDeleteName').textContent = user.name;

    document.getElementById('userToDeleteInfo').innerHTML = `
        <div class="row">
            <div class="col-sm-3"><strong>Nome:</strong></div>
            <div class="col-sm-9">${user.name}</div>
        </div>
        <div class="row">
            <div class="col-sm-3"><strong>Email:</strong></div>
            <div class="col-sm-9">${user.email}</div>
        </div>
        <div class="row">
            <div class="col-sm-3"><strong>Ruolo:</strong></div>
            <div class="col-sm-9">${getRoleName(user.role)}</div>
        </div>
        <div class="row">
            <div class="col-sm-3"><strong>Dispositivi:</strong></div>
            <div class="col-sm-9">${user.allDevicesAccess ? 'Tutti' : (user.deviceIds ? user.deviceIds.length : 0)}</div>
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
    modal.show();
}

function saveUser() {
    const form = document.getElementById('userForm');
    const formData = new FormData(form);

    // Validation
    if (!formData.get('name') || !formData.get('email')) {
        showAlert('Nome e email sono campi obbligatori', 'warning');
        return;
    }

    if (!isEditingUser && (!formData.get('password') || !formData.get('passwordConfirm'))) {
        showAlert('Password e conferma password sono obbligatori per nuovi utenti', 'warning');
        return;
    }

    if (formData.get('password') && formData.get('password') !== formData.get('passwordConfirm')) {
        showAlert('Le password non coincidono', 'warning');
        return;
    }

    if (formData.get('password') && !validatePasswordStrength(formData.get('password'))) {
        showAlert('La password deve contenere almeno 8 caratteri con maiuscole, minuscole e numeri', 'warning');
        return;
    }

    // Build user data
    const userData = {
        name: formData.get('name'),
        email: formData.get('email'),
        role: formData.get('role') || 'user',
        phone: formData.get('phone') || null,
        coordinates: formData.get('coordinates') || null,
        notes: formData.get('notes') || null,
        disabled: formData.get('disabled') === 'on',
        readonly: formData.get('readonly') === 'on',
        limitCommands: formData.get('limitCommands') === 'on',
        allDevicesAccess: formData.get('allDevicesAccess') === 'on',
        expirationDate: formData.get('expirationDate') || null
    };

    if (formData.get('password')) {
        userData.password = formData.get('password');
    }

    // Get selected devices if not all devices access
    if (!userData.allDevicesAccess) {
        const selectedDevices = Array.from(document.querySelectorAll('.device-check:checked'))
            .map(cb => parseInt(cb.value));
        userData.deviceIds = selectedDevices;
    }

    const method = isEditingUser ? 'PUT' : 'POST';
    const url = isEditingUser ? `/api/users/${formData.get('id')}` : '/api/users';

    if (isEditingUser) {
        userData.id = parseInt(formData.get('id'));
    }

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const action = isEditingUser ? 'aggiornato' : 'creato';
            showAlert(`Utente ${action} con successo`, 'success');

            const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
            modal.hide();
            loadUsers();
        } else {
            showAlert(data.error || 'Errore nel salvataggio dell\'utente', 'danger');
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        showAlert('Errore nel salvataggio dell\'utente', 'danger');
    });
}

function confirmDeleteUser() {
    if (!userToDeleteId) return;

    fetch(`/api/users/${userToDeleteId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Utente eliminato con successo', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'));
            modal.hide();
            loadUsers();
        } else {
            showAlert(data.error || 'Errore nell\'eliminazione dell\'utente', 'danger');
        }
    })
    .catch(error => {
        console.error('Errore:', error);
        showAlert('Errore nell\'eliminazione dell\'utente', 'danger');
    })
    .finally(() => {
        userToDeleteId = null;
    });
}

function editUserFromDetails() {
    if (currentUserDetails) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
        modal.hide();
        editUser(currentUserDetails.id);
    }
}

function resetUserForm() {
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('userPassword').required = true;
    document.getElementById('userPasswordConfirm').required = true;
    document.getElementById('userPassword').placeholder = 'Password sicura';
    document.getElementById('userPasswordConfirm').placeholder = 'Ripeti password';
    document.getElementById('deviceSelectionContainer').style.display = 'block';

    // Uncheck all devices
    document.querySelectorAll('.device-check').forEach(cb => cb.checked = false);
}

// Utility functions
function filterUsers() {
    // This would filter the users table based on search and filter criteria
    // Implementation similar to devices filtering
    renderUsersTable();
}

function sortUsers() {
    // This would sort the users array based on selected criteria
    renderUsersTable();
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.user-checkbox');

    checkboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
    });

    updateBulkActions();
}

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

    bulkDeleteBtn.disabled = checkboxes.length === 0;

    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.user-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');

    if (checkboxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkboxes.length === allCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function bulkDeleteUsers() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

    if (selectedIds.length === 0) return;

    const confirmMsg = `Sei sicuro di voler eliminare ${selectedIds.length} utenti selezionati? Questa azione non può essere annullata.`;

    if (confirm(confirmMsg)) {
        const promises = selectedIds.map(id =>
            fetch(`/api/users/${id}`, { method: 'DELETE' })
                .then(response => response.json())
        );

        Promise.all(promises)
            .then(results => {
                const successful = results.filter(r => r.success).length;
                const failed = results.length - successful;

                if (failed === 0) {
                    showAlert(`${successful} utenti eliminati con successo`, 'success');
                } else {
                    showAlert(`${successful} eliminati, ${failed} errori`, 'warning');
                }

                loadUsers();
            })
            .catch(error => {
                console.error('Errore nell\'eliminazione multipla:', error);
                showAlert('Errore nell\'eliminazione degli utenti', 'danger');
            });
    }
}

function selectAllUsers() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    selectAllCheckbox.checked = !selectAllCheckbox.checked;
    toggleSelectAll();
}

function exportUsers() {
    let csvContent = 'Nome,Email,Ruolo,Telefono,Stato,Ultimo Accesso,Creato\n';

    allUsers.forEach(user => {
        const isActive = !user.disabled && !isExpired(user);
        const lastLogin = user.lastLogin ? formatDateTime(user.lastLogin) : 'Mai';
        const created = user.created ? formatDateTime(user.created) : 'N/A';

        csvContent += `"${user.name}","${user.email}","${getRoleName(user.role)}","${user.phone || ''}","${isActive ? 'Attivo' : 'Inattivo'}","${lastLogin}","${created}"\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `users_export_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showAlert('Utenti esportati con successo', 'success');
}

function importUsers() {
    showAlert('Funzionalità di importazione in sviluppo', 'info');
}

function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling;
    const icon = button.querySelector('i');

    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function validatePassword() {
    const password = document.getElementById('userPassword').value;
    const input = document.getElementById('userPassword');

    if (password && !validatePasswordStrength(password)) {
        input.classList.add('is-invalid');
    } else {
        input.classList.remove('is-invalid');
    }
}

function validatePasswordMatch() {
    const password = document.getElementById('userPassword').value;
    const confirm = document.getElementById('userPasswordConfirm').value;
    const input = document.getElementById('userPasswordConfirm');

    if (confirm && password !== confirm) {
        input.classList.add('is-invalid');
    } else {
        input.classList.remove('is-invalid');
    }
}

function validatePasswordStrength(password) {
    // At least 8 characters, one uppercase, one lowercase, one number
    const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;
    return regex.test(password);
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

function showEmptyMessage() {
    document.getElementById('usersTable').parentElement.parentElement.style.display = 'none';
    document.getElementById('emptyMessage').style.display = 'block';
}

// Helper functions for user data
function isExpired(user) {
    if (!user.expirationDate) return false;
    return new Date(user.expirationDate) < new Date();
}

function isUserOnline(user) {
    // This would check if user is currently online
    // For demo purposes, randomly return true/false
    return user.lastLogin && (Date.now() - new Date(user.lastLogin).getTime()) < 300000; // 5 minutes
}

function getRoleColor(role) {
    const colors = {
        'admin': 'text-danger',
        'manager': 'text-warning',
        'user': 'text-primary',
        'readonly': 'text-secondary'
    };
    return colors[role] || 'text-primary';
}

function getRoleBadgeClass(role) {
    const classes = {
        'admin': 'bg-danger',
        'manager': 'bg-warning',
        'user': 'bg-primary',
        'readonly': 'bg-secondary'
    };
    return classes[role] || 'bg-primary';
}

function getRoleIcon(role) {
    const icons = {
        'admin': 'fa-user-shield',
        'manager': 'fa-user-tie',
        'user': 'fa-user',
        'readonly': 'fa-user-lock'
    };
    return icons[role] || 'fa-user';
}

function getRoleName(role) {
    const names = {
        'admin': 'Amministratore',
        'manager': 'Manager',
        'user': 'Utente',
        'readonly': 'Solo Lettura'
    };
    return names[role] || role;
}

function getUserDeviceNames(user) {
    if (user.allDevicesAccess || !user.deviceIds) return [];

    return user.deviceIds.map(deviceId => {
        const device = allDevices.find(d => d.id === deviceId);
        return device ? device.name : `Dispositivo ${deviceId}`;
    });
}

function formatDateTime(dateTimeString) {
    return new Date(dateTimeString).toLocaleString('it-IT');
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('it-IT');
}

function showAlert(message, type = 'info') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed"
             style="top: 80px; right: 20px; z-index: 2000; min-width: 300px;" role="alert">
            <i class="fas fa-${getAlertIcon(type)}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', alertHtml);

    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

function getAlertIcon(type) {
    const icons = {
        'success': 'check-circle',
        'danger': 'exclamation-triangle',
        'warning': 'exclamation-circle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}
</script>
{% endblock %}