{% extends "base.html" %}

{% block title %}Dashboard - Traccar{% endblock %}

{% block page_title %}Dashboard Dispositivi{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
                <div>
                    <h2 class="h3 mb-1">
                        <i class="fas fa-tachometer-alt text-primary me-2"></i>
                        Dashboard Dispositivi
                    </h2>
                    <p class="text-muted mb-0">Panoramica generale dei tuoi dispositivi GPS</p>
                </div>
                <div class="d-flex flex-column flex-sm-row gap-2">
                    <a href="/devices" class="btn btn-primary">
                        <i class="fas fa-cogs me-1"></i>
                        <span class="d-none d-sm-inline">Gestisci </span>Dispositivi
                    </a>
                    <button class="btn btn-outline-primary" onclick="loadDevices()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Aggiorna
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4" id="stats-row">
        <div class="col-6 col-lg-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="text-start">
                            <h3 class="h4 mb-1 text-primary" id="totalDevices">-</h3>
                            <p class="small text-muted mb-0">Totale Dispositivi</p>
                        </div>
                        <div class="text-primary opacity-75">
                            <i class="fas fa-mobile-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="text-start">
                            <h3 class="h4 mb-1 text-success" id="onlineDevices">-</h3>
                            <p class="small text-muted mb-0">Online</p>
                        </div>
                        <div class="text-success opacity-75">
                            <i class="fas fa-wifi fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="text-start">
                            <h3 class="h4 mb-1 text-danger" id="offlineDevices">-</h3>
                            <p class="small text-muted mb-0">Offline</p>
                        </div>
                        <div class="text-danger opacity-75">
                            <i class="fas fa-wifi-slash fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="text-start">
                            <h3 class="h4 mb-1 text-warning" id="movingDevices">-</h3>
                            <p class="small text-muted mb-0">In Movimento</p>
                        </div>
                        <div class="text-warning opacity-75">
                            <i class="fas fa-car fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Controls -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <div class="row g-3 align-items-center">
                        <div class="col-12 col-md-4 col-lg-3">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-start-0" id="searchFilter"
                                       placeholder="Cerca dispositivo...">
                            </div>
                        </div>
                        <div class="col-6 col-md-4 col-lg-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">Tutti gli stati</option>
                                <option value="online">Solo online</option>
                                <option value="offline">Solo offline</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-4 col-lg-2">
                            <select class="form-select" id="viewMode">
                                <option value="cards">Vista a carte</option>
                                <option value="table">Vista tabella</option>
                            </select>
                        </div>
                        <div class="col-12 col-lg-3">
                            <div class="form-check form-switch d-flex align-items-center">
                                <input class="form-check-input me-2" type="checkbox" id="autoRefresh" checked>
                                <label class="form-check-label text-nowrap" for="autoRefresh">
                                    Aggiornamento automatico
                                </label>
                            </div>
                        </div>
                        <div class="col-12 col-lg-2 text-end">
                            <small class="text-muted d-block">
                                Ultimo aggiornamento: <br>
                                <span id="lastUpdate" class="fw-bold">-</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="loading-spinner" style="display: none;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Caricamento...</span>
        </div>
        <p class="mt-3 text-muted">Caricamento dispositivi...</p>
    </div>

    <!-- Devices Cards View -->
    <div class="row g-3" id="devices-container">
        <!-- I dispositivi verranno caricati qui via JavaScript -->
    </div>

    <!-- Devices Table View -->
    <div id="devices-table" class="card border-0 shadow-sm" style="display: none;">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-table me-2"></i>
                Lista Dispositivi
            </h6>
            <small class="text-muted">
                Totale: <span id="totalDevicesInTable">0</span>
            </small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="devicesTableEl">
                    <thead class="bg-light">
                        <tr>
                            <th class="border-0">Nome</th>
                            <th class="border-0">IMEI</th>
                            <th class="border-0">Stato</th>
                            <th class="border-0">Posizione</th>
                            <th class="border-0">Velocità</th>
                            <th class="border-0">Ultimo Aggiornamento</th>
                            <th class="border-0 text-center">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="devices-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="text-center py-5" style="display: none;">
        <div class="mb-4">
            <i class="fas fa-mobile-alt fa-4x text-muted opacity-50"></i>
        </div>
        <h4 class="text-muted mb-2">Nessun dispositivo trovato</h4>
        <p class="text-muted mb-4">I dispositivi verranno visualizzati qui una volta aggiunti al sistema</p>

        <div class="d-flex flex-column flex-sm-row gap-2 justify-content-center">
            <button class="btn btn-outline-primary" onclick="loadDevices()">
                <i class="fas fa-sync-alt me-1"></i>
                Riprova
            </button>
            {% if session.user_admin or session.user_manager %}
            <a href="/devices" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>
                Aggiungi Dispositivo
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Actions Modal -->
<div class="modal fade" id="quickActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bolt me-2"></i>
                    Azioni Rapide
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshAllDevices()">
                        <i class="fas fa-sync-alt me-2"></i>
                        Aggiorna Tutti i Dispositivi
                    </button>
                    <button class="btn btn-outline-info" onclick="openMapView()">
                        <i class="fas fa-map me-2"></i>
                        Visualizza Mappa
                    </button>
                    <button class="btn btn-outline-success" onclick="exportDeviceList()">
                        <i class="fas fa-download me-2"></i>
                        Esporta Lista Dispositivi
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let devices = [];
let devicesStatus = {};
let autoRefreshInterval;
let currentViewMode = 'cards';

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard initialized');
    loadDevices();
    setupEventListeners();
    startAutoRefresh();
});

// Setup event listeners
function setupEventListeners() {
    // Search filter with debounce
    let searchTimeout;
    const searchInput = document.getElementById('searchFilter');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterDevices, 300);
        });
    }

    // Status filter
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', filterDevices);
    }

    // View mode toggle
    const viewMode = document.getElementById('viewMode');
    if (viewMode) {
        viewMode.addEventListener('change', function() {
            currentViewMode = this.value;
            toggleViewMode(currentViewMode);
            renderDevices();
        });
    }

    // Auto refresh toggle
    const autoRefresh = document.getElementById('autoRefresh');
    if (autoRefresh) {
        autoRefresh.addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
                showToast('Aggiornamento automatico attivato', 'info');
            } else {
                stopAutoRefresh();
                showToast('Aggiornamento automatico disattivato', 'info');
            }
        });
    }
}

// Load devices from API
function loadDevices() {
    console.log('Loading devices...');
    showLoading(true);

    fetch('/api/devices')
        .then(response => response.json())
        .then(devicesData => {
            console.log('Devices loaded:', devicesData.length);
            devices = devicesData;
            loadAllDevicesStatus();
            updateLastUpdate();
        })
        .catch(error => {
            console.error('Error loading devices:', error);
            showToast('Errore nel caricamento dei dispositivi', 'danger');
            showEmptyState();
        })
        .finally(() => {
            showLoading(false);
        });
}

// Load status for all devices
function loadAllDevicesStatus() {
    if (devices.length === 0) {
        updateStatistics();
        showEmptyState();
        return;
    }

    const promises = devices.map(device =>
        fetch(`/api/device/${device.id}/status`)
            .then(response => response.json())
            .then(status => {
                devicesStatus[device.id] = status;
                return { device, status };
            })
            .catch(error => {
                console.error(`Error loading status for device ${device.id}:`, error);
                devicesStatus[device.id] = null;
                return { device, status: null };
            })
    );

    Promise.allSettled(promises).then((results) => {
        console.log('Device statuses loaded');
        updateStatistics();
        renderDevices();
        filterDevices();
    });
}

// Update statistics cards
function updateStatistics() {
    const total = devices.length;
    let online = 0;
    let moving = 0;

    devices.forEach(device => {
        const status = devicesStatus[device.id];
        if (status && isDeviceOnline(status)) {
            online++;
            if (status.speed && status.speed > 5) {
                moving++;
            }
        }
    });

    const offline = total - online;

    updateStatCard('totalDevices', total);
    updateStatCard('onlineDevices', online);
    updateStatCard('offlineDevices', offline);
    updateStatCard('movingDevices', moving);
}

// Update individual stat card with animation
function updateStatCard(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        // Add animation class
        element.style.transform = 'scale(1.1)';
        element.textContent = value;

        setTimeout(() => {
            element.style.transform = 'scale(1)';
        }, 150);
    }
}

// Render devices based on current view mode
function renderDevices() {
    if (currentViewMode === 'table') {
        renderTableView();
    } else {
        renderCardsView();
    }
}

// Render devices as cards
function renderCardsView() {
    const container = document.getElementById('devices-container');
    const tableView = document.getElementById('devices-table');

    container.style.display = 'block';
    tableView.style.display = 'none';

    if (devices.length === 0) {
        showEmptyState();
        return;
    }

    container.innerHTML = '';

    devices.forEach(device => {
        const status = devicesStatus[device.id];
        const isOnline = isDeviceOnline(status);
        const isMoving = status && status.speed && status.speed > 5;
        const lastUpdate = status ? new Date(status.serverTime) : null;

        const deviceCard = document.createElement('div');
        deviceCard.className = 'col-12 col-md-6 col-xl-4 device-item';
        deviceCard.setAttribute('data-device-name', device.name.toLowerCase());
        deviceCard.setAttribute('data-device-status', isOnline ? 'online' : 'offline');

        deviceCard.innerHTML = `
            <div class="card h-100 border-0 shadow-sm device-card">
                <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-truncate flex-grow-1 me-2" title="${device.name}">
                        <i class="fas fa-mobile-alt text-primary me-2"></i>
                        ${device.name}
                    </h6>
                    <div class="d-flex gap-1">
                        <span class="badge ${isOnline ? 'bg-success' : 'bg-danger'} rounded-pill">
                            <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                            ${isOnline ? 'Online' : 'Offline'}
                        </span>
                        ${isMoving ? '<span class="badge bg-warning rounded-pill"><i class="fas fa-car"></i></span>' : ''}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3 text-center">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="small text-muted mb-1">IMEI</div>
                                <div class="fw-bold small">${device.uniqueId}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="small text-muted mb-1">Velocità</div>
                                <div class="fw-bold ${isMoving ? 'text-warning' : 'text-muted'}">
                                    ${status ? Math.round(status.speed || 0) : 0} km/h
                                </div>
                            </div>
                        </div>
                    </div>

                    ${status ? `
                        <div class="mt-3">
                            <div class="small text-muted mb-1">Ultima posizione:</div>
                            <div class="small">
                                <i class="fas fa-map-marker-alt text-danger me-1"></i>
                                ${status.latitude.toFixed(4)}, ${status.longitude.toFixed(4)}
                            </div>
                            <div class="small text-muted mt-1">
                                <i class="fas fa-clock me-1"></i>
                                ${lastUpdate ? formatDateTime(lastUpdate.toISOString()) : 'N/A'}
                            </div>
                        </div>
                    ` : `
                        <div class="mt-3 text-center">
                            <div class="text-muted">
                                <i class="fas fa-exclamation-triangle"></i>
                                Nessuna posizione disponibile
                            </div>
                        </div>
                    `}
                </div>
                <div class="card-footer bg-transparent border-0 pt-0">
                    <div class="d-grid gap-1">
                        <div class="btn-group btn-group-sm">
                            <a href="/device/${device.id}" class="btn btn-primary">
                                <i class="fas fa-info-circle me-1"></i>
                                Dettagli
                            </a>
                            <button class="btn btn-outline-primary" onclick="showOnMap(${device.id})" title="Visualizza su mappa">
                                <i class="fas fa-map"></i>
                            </button>
                            ${status ? `
                                <button class="btn btn-outline-success" onclick="centerOnDevice(${status.latitude}, ${status.longitude})" title="Centra su mappa">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(deviceCard);
    });

    hideEmptyState();
}

// Render devices as table
function renderTableView() {
    const container = document.getElementById('devices-container');
    const tableView = document.getElementById('devices-table');
    const tbody = document.getElementById('devices-table-body');
    const totalEl = document.getElementById('totalDevicesInTable');

    container.style.display = 'none';
    tableView.style.display = 'block';

    if (devices.length === 0) {
        showEmptyState();
        return;
    }

    tbody.innerHTML = '';
    totalEl.textContent = devices.length;

    devices.forEach(device => {
        const status = devicesStatus[device.id];
        const isOnline = isDeviceOnline(status);
        const isMoving = status && status.speed && status.speed > 5;

        const row = document.createElement('tr');
        row.className = 'device-item';
        row.setAttribute('data-device-name', device.name.toLowerCase());
        row.setAttribute('data-device-status', isOnline ? 'online' : 'offline');

        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-mobile-alt text-primary me-2"></i>
                    <div>
                        <div class="fw-bold">${device.name}</div>
                        <small class="text-muted">${device.phone || 'N/A'}</small>
                    </div>
                </div>
            </td>
            <td><code class="small">${device.uniqueId}</code></td>
            <td>
                <span class="badge ${isOnline ? 'bg-success' : 'bg-danger'} rounded-pill">
                    <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                    ${isOnline ? 'Online' : 'Offline'}
                </span>
                ${isMoving ? '<span class="badge bg-warning rounded-pill ms-1"><i class="fas fa-car"></i></span>' : ''}
            </td>
            <td>
                ${status ? `
                    <div class="small">
                        ${status.latitude.toFixed(4)}, ${status.longitude.toFixed(4)}
                    </div>
                ` : '<span class="text-muted">N/A</span>'}
            </td>
            <td>
                <span class="badge ${isMoving ? 'bg-warning' : 'bg-secondary'} rounded-pill">
                    ${status ? Math.round(status.speed || 0) : 0} km/h
                </span>
            </td>
            <td>
                <small>${status ? formatDateTime(status.serverTime) : 'N/A'}</small>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <a href="/device/${device.id}" class="btn btn-outline-primary btn-sm" title="Dettagli">
                        <i class="fas fa-info-circle"></i>
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" onclick="showOnMap(${device.id})" title="Mappa">
                        <i class="fas fa-map"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    hideEmptyState();
}

// Toggle between card and table view
function toggleViewMode(mode) {
    currentViewMode = mode;
    localStorage.setItem('dashboardViewMode', mode);
}

// Filter devices based on search and status
function filterDevices() {
    const searchTerm = document.getElementById('searchFilter')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    const deviceItems = document.querySelectorAll('.device-item');

    let visibleCount = 0;

    deviceItems.forEach(item => {
        const deviceName = item.getAttribute('data-device-name') || '';
        const deviceStatus = item.getAttribute('data-device-status') || '';

        const matchesSearch = deviceName.includes(searchTerm);
        const matchesStatus = !statusFilter || deviceStatus === statusFilter;

        if (matchesSearch && matchesStatus) {
            item.style.display = '';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });

    // Show empty state if no devices match
    if (visibleCount === 0 && devices.length > 0) {
        showEmptyState('Nessun dispositivo corrisponde ai filtri', 'Prova a modificare i criteri di ricerca');
    } else if (visibleCount > 0) {
        hideEmptyState();
    }
}

// Utility functions
function isDeviceOnline(status) {
    if (!status) return false;
    const lastUpdate = new Date(status.serverTime);
    const now = new Date();
    const diffMinutes = (now - lastUpdate) / (1000 * 60);
    return diffMinutes < 5;
}

function showLoading(show) {
    const loading = document.getElementById('loading');
    const container = document.getElementById('devices-container');
    const tableView = document.getElementById('devices-table');

    if (loading) loading.style.display = show ? 'block' : 'none';
    if (container) container.style.display = show ? 'none' : 'block';
    if (tableView && currentViewMode === 'table') {
        tableView.style.display = show ? 'none' : 'block';
    }
}

function showEmptyState(title = 'Nessun dispositivo trovato', subtitle = 'I dispositivi verranno visualizzati qui una volta aggiunti al sistema') {
    const emptyState = document.getElementById('empty-state');
    const container = document.getElementById('devices-container');
    const tableView = document.getElementById('devices-table');

    if (emptyState) {
        emptyState.querySelector('h4').textContent = title;
        emptyState.querySelector('p').textContent = subtitle;
        emptyState.style.display = 'block';
    }
    if (container) container.style.display = 'none';
    if (tableView) tableView.style.display = 'none';
}

function hideEmptyState() {
    const emptyState = document.getElementById('empty-state');
    if (emptyState) emptyState.style.display = 'none';
}

function updateLastUpdate() {
    const element = document.getElementById('lastUpdate');
    if (element) {
        element.textContent = new Date().toLocaleTimeString('it-IT');
    }
}

// Auto refresh functionality
function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);

    autoRefreshInterval = setInterval(() => {
        if (document.getElementById('autoRefresh')?.checked) {
            console.log('Auto-refreshing devices...');
            loadDevices();
        }
    }, 30000); // Every 30 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Navigation functions
function showOnMap(deviceId) {
    window.location.href = `/map?device=${deviceId}`;
}

function centerOnDevice(lat, lng) {
    window.open(`/map?lat=${lat}&lng=${lng}&zoom=16`, '_blank');
}

// Quick actions
function refreshAllDevices() {
    loadDevices();
    const modal = bootstrap.Modal.getInstance(document.getElementById('quickActionsModal'));
    modal?.hide();
    showToast('Aggiornamento dispositivi in corso...', 'info');
}

function openMapView() {
    window.location.href = '/map';
}

function exportDeviceList() {
    if (devices.length === 0) {
        showToast('Nessun dispositivo da esportare', 'warning');
        return;
    }

    let csvContent = 'Nome,IMEI,Telefono,Stato,Ultima Posizione,Velocità,Ultimo Aggiornamento\n';

    devices.forEach(device => {
        const status = devicesStatus[device.id];
        const isOnline = isDeviceOnline(status);

        csvContent += `"${device.name}","${device.uniqueId}","${device.phone || 'N/A'}","${isOnline ? 'Online' : 'Offline'}"`;

        if (status) {
            csvContent += `,"${status.latitude.toFixed(6)}, ${status.longitude.toFixed(6)}","${Math.round(status.speed || 0)} km/h","${formatDateTime(status.serverTime)}"`;
        } else {
            csvContent += ',"N/A","0 km/h","N/A"';
        }

        csvContent += '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `dispositivi_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast('Lista dispositivi esportata con successo', 'success');

    const modal = bootstrap.Modal.getInstance(document.getElementById('quickActionsModal'));
    modal?.hide();
}

// Override global refresh function
function updateDevices() {
    loadDevices();
}

console.log('✅ Dashboard script loaded successfully');
</script>
{% endblock %}